#!/bin/bash

### Set default editor to nano (don't judge me...) ###
export VISUAL=nano
export EDITOR="$VISUAL"

### Source virtualenvwrapper ###
if [[ -f /usr/local/bin/virtualenvwrapper.sh ]]; then
    export WORKON_HOME=$HOME/.virtualenvs
    source /usr/local/bin/virtualenvwrapper.sh
fi

### Add git branch to PS1 ###
gitps1=true
if [[ -f /etc/bash_completion.d/git ]]; then
    source /etc/bash_completion.d/git
elif [[ -f /Library/Developer/CommandLineTools/usr/share/git-core/git-prompt.sh ]]; then
    source /Library/Developer/CommandLineTools/usr/share/git-core/git-prompt.sh
elif [[ -f /Applications/Xcode.app/Contents/Developer/usr/share/git-core/git-prompt.sh ]]; then
    source /Applications/Xcode.app/Contents/Developer/usr/share/git-core/git-prompt.sh
else
    gitps1=false
fi
if [[ "$gitps1" == true ]]; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
        PS1="[\[\033[32m\]\w]\[\033[0m\]\$(__git_ps1)\[\033[1;36m\] \u\[\033[32m\]$ \[\\033[0m\]"
    else
        PS1="[\[\033[32m\]\w]\[\033[0m\]\$(__git_ps1)\[\033[1;36m\] \u\[\033[32m\]$ \[\033[0m\]"
    fi
fi

### Aliases ###
alias ls="ls -A"
alias ll="ls -AlF"
alias pname="ps aux | grep"
alias wai="clear; pwd; ls"

### Functions ###
function cd () {
    builtin cd "$@";

    # Rename the current tab
    THISDIR=$(echo $PWD | awk -F "/" '{print $NF}');
    printf "\e]1;$THISDIR\a";
}

function killname () {
    # Find the PIDs that match
    ps aux | grep $1 | grep -v grep | awk '{ print $2 }' | while read line; do
        # Kill each PID
        sudo kill -9 $line;
    done
}

# Functions for Mac only
if [[ "$OSTYPE" == "darwin"* ]]; then
    # Activate the Terminal
    function tActivate {
        osascript -e 'tell application "Terminal" to activate' "$@"
    }
    # Open a New Tab
    function tNewtab {
        tActivate -e 'tell application "System Events" to tell process "Terminal" to keystroke "t" using command down' "$@"
    }
    # Perform a given command in a New Tab in the Terminal
    function tCommand {
        FULLCMD=$(echo 'tell application "Terminal" to do script "'$1'" in selected tab of the front window')
        tNewtab -e "$FULLCMD"
    }
fi

### Git Aliases ###
# git trash: stash stage and immediately drop it
git config --global alias.trash '!'"f() { git stash; git stash drop; }; f;"

# Overriding git function required to change behaviour of built-in git functions
function git () {
    # Add custom parameters to git log and branch
    # TODO: do a better job handling additional options to git
    # TODO: consider adding --no-merge
    if [ "$1" == "log" ]; then
        /usr/bin/git "$@" --pretty=format:'%C(dim)%H%C(reset) | %C(yellow)%<(15,trunc)%an%C(reset) | %<(75,trunc)%s | %C(cyan)%<(15,trunc)%cr%C(reset)';
    elif [ "$1" == "branch" ]; then
        /usr/bin/git "$@" -vv;
    else
        /usr/bin/git "$@";
    fi
}
